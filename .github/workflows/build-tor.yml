# Build Tor Executable for Android
# 
# This workflow builds Tor as a standalone executable (not shared library)
# for embedding in Android apps that use ProcessBuilder/exec().
#
# Usage:
#   1. Push this file to a GitHub repository at .github/workflows/build-tor.yml
#   2. Run the workflow manually or on push
#   3. Download the artifact from the Actions tab
#   4. Place 'tor' binary in android/app/src/main/assets/tor/

name: Build Tor Android Executable

on:
  workflow_dispatch:
    inputs:
      tor_version:
        description: 'Tor version to build'
        required: true
        default: '0.4.8.13'
      openssl_version:
        description: 'OpenSSL version'
        required: true
        default: '3.2.1'
      libevent_version:
        description: 'libevent version'
        required: true
        default: '2.1.12-stable'

env:
  ANDROID_NDK_VERSION: '25.2.9519653'
  API_LEVEL: '21'
  TARGET_ABI: 'arm64-v8a'
  TARGET_ARCH: 'aarch64'
  TARGET_TRIPLE: 'aarch64-linux-android'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r25c
          add-to-path: true

      - name: Set environment variables
        run: |
          NDK_PATH="${{ steps.setup-ndk.outputs.ndk-path }}"
          TOOLCHAIN_PATH="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64"
          
          echo "ANDROID_NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
          echo "TOOLCHAIN=$TOOLCHAIN_PATH" >> $GITHUB_ENV
          echo "PATH=$TOOLCHAIN_PATH/bin:$PATH" >> $GITHUB_ENV
          
          # Set compiler variables
          echo "CC=$TOOLCHAIN_PATH/bin/${{ env.TARGET_TRIPLE }}${{ env.API_LEVEL }}-clang" >> $GITHUB_ENV
          echo "CXX=$TOOLCHAIN_PATH/bin/${{ env.TARGET_TRIPLE }}${{ env.API_LEVEL }}-clang++" >> $GITHUB_ENV
          echo "AR=$TOOLCHAIN_PATH/bin/llvm-ar" >> $GITHUB_ENV
          echo "AS=$TOOLCHAIN_PATH/bin/llvm-as" >> $GITHUB_ENV
          echo "LD=$TOOLCHAIN_PATH/bin/ld" >> $GITHUB_ENV
          echo "RANLIB=$TOOLCHAIN_PATH/bin/llvm-ranlib" >> $GITHUB_ENV
          echo "STRIP=$TOOLCHAIN_PATH/bin/llvm-strip" >> $GITHUB_ENV
          echo "NM=$TOOLCHAIN_PATH/bin/llvm-nm" >> $GITHUB_ENV

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool pkg-config

      - name: Create build directories
        run: |
          mkdir -p $HOME/tor-build/prefix
          mkdir -p $HOME/tor-build/output

      - name: Build zlib
        run: |
          cd $HOME/tor-build
          curl -LO https://zlib.net/zlib-1.3.1.tar.gz
          tar xzf zlib-1.3.1.tar.gz
          cd zlib-1.3.1
          
          CHOST=${{ env.TARGET_TRIPLE }} ./configure \
            --prefix=$HOME/tor-build/prefix \
            --static
          
          make -j$(nproc)
          make install

      - name: Build OpenSSL
        run: |
          cd $HOME/tor-build
          OPENSSL_VER="${{ github.event.inputs.openssl_version || '3.2.1' }}"
          curl -LO "https://www.openssl.org/source/openssl-${OPENSSL_VER}.tar.gz"
          tar xzf "openssl-${OPENSSL_VER}.tar.gz"
          cd "openssl-${OPENSSL_VER}"
          
          # Use env var that was already set
          export PATH="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          
          ./Configure android-arm64 \
            --prefix=$HOME/tor-build/prefix \
            --openssldir=$HOME/tor-build/prefix/ssl \
            no-shared \
            no-tests \
            no-ui-console \
            -D__ANDROID_API__=${{ env.API_LEVEL }}
          
          make -j$(nproc)
          make install_sw

      - name: Build libevent
        run: |
          cd $HOME/tor-build
          curl -LO https://github.com/libevent/libevent/releases/download/release-${{ github.event.inputs.libevent_version || '2.1.12-stable' }}/libevent-${{ github.event.inputs.libevent_version || '2.1.12-stable' }}.tar.gz
          tar xzf libevent-${{ github.event.inputs.libevent_version || '2.1.12-stable' }}.tar.gz
          cd libevent-${{ github.event.inputs.libevent_version || '2.1.12-stable' }}
          
          ./configure \
            --host=${{ env.TARGET_TRIPLE }} \
            --prefix=$HOME/tor-build/prefix \
            --disable-shared \
            --enable-static \
            --disable-samples \
            --disable-libevent-regress \
            CFLAGS="-I$HOME/tor-build/prefix/include" \
            LDFLAGS="-L$HOME/tor-build/prefix/lib"
          
          make -j$(nproc)
          make install

      - name: Download Tor source
        run: |
          cd $HOME/tor-build
          TOR_VERSION="${{ github.event.inputs.tor_version || '0.4.8.13' }}"
          curl -LO https://dist.torproject.org/tor-${TOR_VERSION}.tar.gz
          tar xzf tor-${TOR_VERSION}.tar.gz
          mv tor-${TOR_VERSION} tor-src

      - name: Build Tor executable
        run: |
          cd $HOME/tor-build/tor-src
          
          # Configure for Android as EXECUTABLE (not library)
          ./configure \
            --host=${{ env.TARGET_TRIPLE }} \
            --prefix=$HOME/tor-build/prefix \
            --disable-asciidoc \
            --disable-system-torrc \
            --disable-tool-name-check \
            --disable-lzma \
            --disable-zstd \
            --enable-static-tor \
            --with-libevent-dir=$HOME/tor-build/prefix \
            --with-openssl-dir=$HOME/tor-build/prefix \
            --with-zlib-dir=$HOME/tor-build/prefix \
            CFLAGS="-I$HOME/tor-build/prefix/include -O2 -fPIE -fPIC" \
            LDFLAGS="-L$HOME/tor-build/prefix/lib -pie -static-libstdc++"
          
          make -j$(nproc)

      - name: Verify and strip binary
        run: |
          cd $HOME/tor-build/tor-src
          
          echo "=== Before stripping ==="
          file src/app/tor
          ls -la src/app/tor
          readelf -h src/app/tor | head -20
          
          # Strip debug symbols
          $STRIP --strip-all src/app/tor
          
          echo ""
          echo "=== After stripping ==="
          file src/app/tor
          ls -la src/app/tor
          readelf -h src/app/tor | head -20
          
          # Verify it's an executable, not shared library
          TYPE=$(readelf -h src/app/tor | grep "Type:" | awk '{print $2}')
          if [[ "$TYPE" == "DYN" ]]; then
            # Check if it's PIE executable or just a shared object
            if readelf -h src/app/tor | grep -q "Entry point address:.*0x0"; then
              echo "ERROR: Binary is a shared object, not executable!"
              exit 1
            fi
          fi
          
          echo ""
          echo "=== Entry point verification ==="
          readelf -h src/app/tor | grep "Entry point"
          
          # Copy to output
          cp src/app/tor $HOME/tor-build/output/tor

      - name: Download GeoIP files
        run: |
          cd $HOME/tor-build/output
          curl -L https://gitlab.torproject.org/tpo/core/tor/-/raw/main/src/config/geoip -o geoip
          curl -L https://gitlab.torproject.org/tpo/core/tor/-/raw/main/src/config/geoip6 -o geoip6

      - name: Create build info
        run: |
          cd $HOME/tor-build/output
          cat > BUILD_INFO.txt << EOF
          Tor Android Executable Build
          =============================
          Tor Version: ${{ github.event.inputs.tor_version || '0.4.8.13' }}
          OpenSSL Version: ${{ github.event.inputs.openssl_version || '3.2.1' }}
          libevent Version: ${{ github.event.inputs.libevent_version || '2.1.12-stable' }}
          Target: ${{ env.TARGET_TRIPLE }}
          ABI: ${{ env.TARGET_ABI }}
          API Level: ${{ env.API_LEVEL }}
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Runner: ${{ runner.os }}
          Workflow Run: ${{ github.run_id }}
          
          Binary Type: Executable (PIE)
          Usage: ProcessBuilder / exec()
          
          Verification:
          $(file $HOME/tor-build/output/tor)
          $(readelf -h $HOME/tor-build/output/tor | grep -E "Type:|Entry point")
          EOF
          
          cat BUILD_INFO.txt

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tor-android-arm64-v8a
          path: |
            /home/runner/tor-build/output/tor
            /home/runner/tor-build/output/geoip
            /home/runner/tor-build/output/geoip6
            /home/runner/tor-build/output/BUILD_INFO.txt
          retention-days: 90
